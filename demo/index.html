<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staga Demo</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    section { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc; }
    pre { background: #f0f0f0; padding: 1rem; }
    button { margin-right: .5rem; }
    nav ul { line-height: 1.8; }
  </style>
  <script src="../dist/index.global.js"></script>
</head>
<body>
  <h1>Staga Demo</h1>
  <p>Examples of core Staga features. Use the links below to jump to a section.</p>
  <nav>
    <ul>
      <li><a href="#state-management">State Management</a></li>
      <li><a href="#reactive-selectors">Reactive Selectors</a></li>
      <li><a href="#transactions">Transactions</a></li>
      <li><a href="#event-replay">Event Replay</a></li>
    </ul>
  </nav>

  <section id="state-management">
    <h2>State Management</h2>
    <button id="sm-rename">Rename User</button>
    <button id="sm-undo">Undo</button>
    <button id="sm-redo">Redo</button>
    <pre id="sm-state"></pre>
    <script>
      (() => {
        const saga = window.Staga.SagaManager.create({
          user: { name: 'Alice', balance: 100 }
        });

        const stateElem = document.getElementById('sm-state');
        const state$ = saga.select(s => s);
        state$.subscribe(state => {
          stateElem.textContent = JSON.stringify(state, null, 2);
        });

        document.getElementById('sm-rename').onclick = () => {
          const current = saga.getState();
          const name = current.user.name === 'Alice' ? 'Bob' : 'Alice';
          saga.stateManager.setState({
            ...current,
            user: { ...current.user, name }
          });
        };

        document.getElementById('sm-undo').onclick = () => saga.undo();
        document.getElementById('sm-redo').onclick = () => saga.redo();
      })();
    </script>
  </section>

  <section id="reactive-selectors">
    <h2>Reactive Selectors</h2>
    <button id="rs-addFunds">Add $50</button>
    <button id="rs-raisePrice">Increase Price</button>
    <div>Balance: <span id="rs-balance"></span></div>
    <div>Price: <span id="rs-price"></span></div>
    <div>Can afford? <span id="rs-afford"></span></div>
    <script>
      (() => {
        const saga = window.Staga.SagaManager.create({
          user: { balance: 100 },
          item: { price: 75 }
        });

        const balance$ = saga.selectProperty('user').select(u => u.balance);
        const price$ = saga.selectProperty('item').select(i => i.price);
        const canAfford$ = saga.computed(balance$, price$, (b, p) => b >= p);

        balance$.subscribe(b => document.getElementById('rs-balance').textContent = b);
        price$.subscribe(p => document.getElementById('rs-price').textContent = p);
        canAfford$.subscribe(a => document.getElementById('rs-afford').textContent = a ? 'yes' : 'no');

        document.getElementById('rs-addFunds').onclick = () => {
          const s = saga.getState();
          saga.stateManager.setState({
            ...s,
            user: { balance: s.user.balance + 50 },
            item: s.item
          });
        };

        document.getElementById('rs-raisePrice').onclick = () => {
          const s = saga.getState();
          saga.stateManager.setState({
            ...s,
            item: { price: s.item.price + 20 },
            user: s.user
          });
        };
      })();
    </script>
  </section>

  <section id="transactions">
    <h2>Transactions</h2>
    <button id="tr-buy">Buy Item ($40)</button>
    <div>Balance: <span id="tr-balance"></span></div>
    <pre id="tr-log"></pre>
    <script>
      (() => {
        const saga = window.Staga.SagaManager.create({
          user: { balance: 100 },
          orders: []
        });

        const log = msg => {
          const pre = document.getElementById('tr-log');
          pre.textContent += msg + '\n';
        };

        const purchase = saga
          .createTransaction('purchase')
          .addStep('check-funds', state => {
            if (state.user.balance < 40) throw new Error('Not enough funds');
          })
          .addStep('debit', state => {
            saga.stateManager.setState({
              ...state,
              user: { ...state.user, balance: state.user.balance - 40 },
              orders: [...state.orders, { id: Date.now(), price: 40 }]
            });
          });

        document.getElementById('tr-buy').onclick = async () => {
          try {
            await purchase.run();
            log('\u2713 purchase success');
          } catch (err) {
            log('\u2717 purchase failed: ' + err.message);
          }
        };

        const balance$ = saga.selectProperty('user').select(u => u.balance);
        balance$.subscribe(b => document.getElementById('tr-balance').textContent = b);
      })();
    </script>
  </section>

  <section id="event-replay">
    <h2>Event Replay</h2>
    <button id="er-start">Start Recording</button>
    <button id="er-stop">Stop Recording</button>
    <button id="er-replay">Replay Events</button>
    <button id="er-increment">Increment Counter</button>
    <div>Counter: <span id="er-counter"></span></div>
    <pre id="er-log"></pre>
    <script>
      (() => {
        const saga = window.Staga.SagaManager.create({ counter: 0 });

        const counter$ = saga.select(s => s.counter);
        counter$.subscribe(v => document.getElementById('er-counter').textContent = v);

        const log = m => {
          const pre = document.getElementById('er-log');
          pre.textContent += m + '\n';
        };

        document.getElementById('er-increment').onclick = () => {
          const s = saga.getState();
          saga.stateManager.setState({ counter: s.counter + 1 });
        };

        document.getElementById('er-start').onclick = () => {
          saga.startRecording();
          log('recording started');
        };

        document.getElementById('er-stop').onclick = () => {
          saga.stopRecording();
          log('recording stopped');
        };

        document.getElementById('er-replay').onclick = () => {
          saga.startReplay();
          log('replay started');
        };

        saga.on('replay:finished', () => log('replay finished'));
      })();
    </script>
  </section>
</body>
</html>
